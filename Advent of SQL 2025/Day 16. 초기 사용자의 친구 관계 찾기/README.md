# [Day 16] 초기 사용자의 친구 관계 찾기

[문제 링크](https://solvesql.com/problems/friendship-between-early-users/)

### 제출 일자

2025년 12월 16일 14:05

### 문제 설명
Facebook 소셜 네트워크 데이터베이스는 Facebook 서비스에서 샘플링한 사용자의 메타 정보와 사용자 사이의 친구 관계를 담고 있습니다. edges 테이블에는 사용자의 친구 관계 정보가 들어있는데 각 행의 user_a_id 컬럼 사용자와 user_b_id 컬럼 사용자가 서로 친구 관계라는 의미 입니다.

이 데이터베이스에 저장된 Facebook 사용자의 ID는 순차 생성(auto increment)된 정수 이기 때문에 ID 번호가 낮을 수록 일찍 가입한 사용자 입니다. 이를 바탕으로 어떤 친구 관계에 대해서 서로 친구인 두 ID를 더하면 친구 관계가 발생한 시점을 간접적으로 추측할 수 있습니다. 예를 들어, ID 4번 사용자와 ID 10번 사용자의 친구 관계는 ID 27번 사용자와 ID 68번인 사용자의 친구 관계보다 일찍 생성되었을 것으로 추측할 수 있습니다.

이런 추측을 바탕으로 초창기 Facebook 사용자의 친구 관계 형성을 분석하기 위해 전체 친구 관계 중 초기 0.1%의 친구 관계만 추출하려고 합니다. 데이터베이스를 조회해 친구 관계인 두 사용자 ID의 합이 상위 0.1%에 들어오는 모든 친구 관계를 출력하는 쿼리를 작성해주세요. 쿼리 결과에는 아래 컬럼이 있어야 합니다.


- user_a_id: 친구 관계인 사용자 ID (A)
- user_b_id: 친구 관계인 사용자 ID (B)
- id_sum: 두 사용자 ID의 합


문제 수정 (2025-12-16 01:06:00)
상위 %의 정의는 해당 친구 관계의 순위 / 전체 친구 관계의 수로 정의합니다. 예를 들어, 전체 100개의 친구 관계가 있을 때 순위가 10등인 친구 관계의 %는 0.1 입니다. (= 10 / 100) 만약, 상위 0.1%의 경계 부분에서 id_sum 값이 같은 친구 관계가 여러개 있는 경우, 이 중 어떠한 관계가 포함되어도 정답으로 처리됩니다.

힌트
이 문제는 DBMS에 따라 접근 방법이 달라지는 문제입니다. 다양한 DBMS에서의 접근법을 생각하며 쿼리를 작성해보세요.

---

### 정답

```sql
-- 전체 친구 관계 중 초기 0.1%의 친구 관계만 추출
-- 두 사용자의 ID의 합이 상위 0.1%이내인 친구 관계 출력하기
-- 새로운 컬럼 만들기  (사용자 ID 합)
-- id_sum 오름차순 정렬 
-- 0.1% 이내만 출력하기
  -- ranking 컬럼 만들기
  -- 총 row의 개수 구하기 (COUNT(*))
  -- where ranking / row_num <= 0.1 조건 추가
WITH point AS (
  SELECT 
    user_a_id
    , user_b_id
    , (user_a_id + user_b_id) AS 'id_sum'
    , rank() over (ORDER BY (user_a_id + user_b_id)) AS 'ranking'
  FROM edges
)
, row_num AS (
  SELECT COUNT(*) AS 'count_row'
  FROM edges
)
SELECT 
  user_a_id
  , user_b_id
  , id_sum
FROM point, row_num
WHERE (ranking / count_row) <= 0.001
;
```

### 풀이 과정

- 처음부터 코드를 작성하지 않고, 차근차근 로직을 짜며 주석을 썼다.
- id_sum이라는 새로운 컬럼을 만든 뒤, 상위 0.1%를 어떻게 출력할까 고민했다.
- INDEX 번호, 행 번호로 추출을 하고 싶었는데, 잘 모르겠어서 RANK() 함수를 사용해 순위를 구했다.
- 그리고 COUNT(*)로 전체 데이터의 개수를 구해서 열을 하나 더 추가했다.
- 0.1과 0.1%는 다름을 깨달았다.

