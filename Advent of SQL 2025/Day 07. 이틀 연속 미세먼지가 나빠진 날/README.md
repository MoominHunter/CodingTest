# [Day 07] 이틀 연속 미세먼지가 나빠진 날

[문제 링크](https://solvesql.com/problems/bad-finddust-days-in-a-row/) 

### 제출 일자

2025년 12월 7일 14:10

### 문제 설명

서울숲 일별 평균 대기오염도 데이터베이스는 2022년 서울숲 대기 측정소에서 매일 기록한 다양한 대기오염 정보를 담고 있습니다.

미세먼지 수치가 지속적으로 나빠지는 경우를 추출해 해당 일자 부근의 서울숲 대기를 상세하게 분석해보려고 합니다. 이를 위해 2022년 중 이틀 연속 미세먼지 수치가 나빠져 30㎍/㎥ 이상이 된 날을 추출하는 쿼리를 작성해주세요. 예를 들어, 1월 3일의 미세먼지 수치가 28㎍/㎥ 이고, 1월 4일의 미세먼지 수치가 37㎍/㎥, 1월 5일의 미세먼지 수치가 52㎍/㎥ 이라면 1월 5일이 이틀 연속 미세먼지 수치가 나빠져 30㎍/㎥ 이상이 된 날 입니다.

쿼리 결과에는 아래 컬럼이 있어야 하고, 날짜 기준 오름차순 정렬되어 있어야 합니다.


- date_alert: 이틀 연속 미세먼지 수치가 나빠져 30㎍/㎥ 이상이 된 날

힌트
2월 23일의 미세먼지 수치는 13㎍/㎥ 이고, 24일의 미세먼지 수치는 18㎍/㎥, 25일의 미세먼지 수치는 56㎍/㎥ 입니다. 따라서, 2월 25일은 이틀 연속 미세먼지 수치가 나빠져 30㎍/㎥ 이상이 된 날 입니다.

4월 17일의 미세먼지 수치는 72㎍/㎥ 이고, 18일의 미세먼지 수치는 73㎍/㎥, 19일의 미세먼지 수치는 90㎍/㎥ 입니다. 따라서, 4월 19일은 이틀 연속 미세먼지 수치가 나빠져 30㎍/㎥ 이상이 된 날 입니다.



---

### 정답

```sql
-- 오늘의 미세먼지 수치(pm10)가 어제보다 나빠지고 (크고)
-- 어제의 미세먼지 수치가 그제보다 나빠졌으며 (크고)
-- 오늘의 미세먼지 수치가 30이상인 날

WITH  -- 일단 이틀 전의 미세먼지 데이터까지 새로운 행으로 만들기 (LAG함수 사용)
  pm10_bad AS (
    SELECT
      measured_at,
      pm10,
      LAG(pm10, 1) OVER (
        ORDER BY
          measured_at
      ) AS 'oneday_pm10',
      LAG(pm10, 2) OVER (
        ORDER BY
          measured_at
      ) AS 'twoday_pm10'
    FROM
      measurements
  )
SELECT
  measured_at AS date_alert -- , pm10, oneday_pm10, twoday_pm10
FROM
  pm10_bad
WHERE
 -- 1. 오늘의 수치가 어제 수치보다 나빠지고 (크고)
  (pm10 > oneday_pm10)
 -- 2. 어제의 미세먼지 수치가 그제보다 나빠지고 (크고)
  AND (oneday_pm10 > twoday_pm10)
 -- 3. 오늘의 미세먼지 수치가 30 이상인 날
  AND (pm10 >= 30)
  AND (oneday_pm10 IS NOT NULL AND twoday_pm10 IS NOT NULL)
ORDER BY
  measured_at ASC
;

```

### 새로 배운 것

-  WITH 'table' AS () 구문

- LAG(), LEAD() 함수 : 이전 행 또는 다음 행의 데이터를 가져와 새로운 열로 만들 수 있다.
  - LAG(가져올 열, 가져올 이전 행의 위치_기본값 1) OVER ([PARTITION] | ORDER BY 정렬기준 열)
  - LEAD(가져올 열, 가져올 다음 행의 위치_기본값 1) OVER ([PARTITION] | ORDER BY 정렬기준 열)

- 문제 요구사항 꼼꼼히 읽기
  - 처음 작성한 쿼리는 단순히 미세먼지 수치가 이틀 연속 30 이상인 날짜만 뽑았다. 하지만 문제에서 요구하는 건, 지속적으로 나빠진 날짜를 뽑는 것이었다. 이 조건이 쿼리에 반영되지 않아서 정답값보다 훨씬 많은 행이 추출되었다.
  - 처음엔 미세먼지가 나빠진 걸 '크거나 같은' 이라고 해석하여 쿼리를 짰는데, 정답보다 7행이 더 많았다. 그래서 등호(=)를 조건에서 뺐고, 정답값과 일치했다. 결과값을 확인하며 쿼리를 차근차근 수정해보면 좋을 것 같다.
